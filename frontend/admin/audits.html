<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Audits - AmazonReach Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen font-display">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-white flex flex-col shrink-0">
            <div class="p-6 flex items-center gap-3">
                <span class="material-symbols-outlined text-blue-400">rocket_launch</span>
                <h1 class="text-xl font-bold">Admin Panel</h1>
            </div>
            <nav class="flex-1 px-4 space-y-1">
                <a href="../dashboard/dashboard.html"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all">
                    <span class="material-symbols-outlined px-1">dashboard</span> Dashboard
                </a>
                <a href="audits.html"
                    class="flex items-center gap-3 px-4 py-3 bg-blue-600 text-white rounded-lg shadow-lg">
                    <span class="material-symbols-outlined px-1">analytics</span> Manage Audits
                </a>
                <a href="../dashboard/blog-editor.html"
                    class="flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all">
                    <span class="material-symbols-outlined px-1">edit_document</span> Blog Editor
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-y-auto bg-slate-50">
            <header
                class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 class="text-xl font-semibold text-slate-800">Pending Audit Requests</h2>
                <button onclick="loadAudits()" class="p-2 text-slate-500 hover:text-blue-600">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
            </header>

            <div class="p-8">
                <div id="auditList" class="grid gap-6">
                    <!-- Cards will be injected here -->
                    <div class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-slate-200 rounded"></div>
                                <div class="h-4 bg-slate-200 rounded w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Generate Modal -->
    <div id="modal"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl border border-slate-200 w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Generate Strategy Report</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div id="clientInfo" class="mb-8 p-4 bg-blue-50 rounded-xl border border-blue-100">
                <!-- Injected info -->
            </div>

            <form id="heliForm" class="space-y-6">
                <input type="hidden" id="currentAuditId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Monthly Revenue ($)</label>
                        <input type="number" id="heliRevenue" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500/20 outline-none"
                            placeholder="e.g. 5000">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">BSR (Best Seller Rank)</label>
                        <input type="text" id="heliBsr" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500/20 outline-none"
                            placeholder="e.g. 15,200">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Review Count</label>
                        <input type="number" id="heliReviews" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500/20 outline-none"
                            placeholder="e.g. 15">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Top Keyword Search Volume</label>
                        <input type="number" id="heliVolume" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500/20 outline-none"
                            placeholder="e.g. 45000">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Market Competition Score
                        (1-10)</label>
                    <input type="range" id="heliComp" min="1" max="10"
                        class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-slate-400 mt-2">
                        <span>1 (Low)</span>
                        <span>10 (Brutal)</span>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" id="genBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        Generate AI Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : 'https://amazonreach-production.up.railway.app';

        async function loadAudits() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/audit/all`, { credentials: 'include' });
                const data = await res.json();

                const list = document.getElementById('auditList');
                list.innerHTML = '';

                if (data.audits.length === 0) {
                    list.innerHTML = '<div class="p-8 text-center text-slate-400">No requests found.</div>';
                    return;
                }

                data.audits.forEach(audit => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row justify-between items-start md:items-center gap-4";

                    const statusColor = audit.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700';
                    const statusText = audit.status.charAt(0).toUpperCase() + audit.status.slice(1);

                    card.innerHTML = `
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-bold ${statusColor}">${statusText}</span>
                                <span class="text-xs text-slate-400">${new Date(audit.created_at).toLocaleDateString()}</span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900">${audit.name}</h3>
                            <p class="text-sm text-slate-500">${audit.email}</p>
                            <div class="mt-2 text-sm">
                                <span class="font-medium text-blue-600">${audit.asin || audit.keyword}</span>
                                <span class="mx-2 text-slate-300">|</span>
                                <span class="text-slate-500">Sales: ${audit.monthly_sales || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            ${audit.status === 'completed'
                            ? `<a href="../audit-view.html?id=${audit.id}" target="_blank" class="px-4 py-2 text-sm font-bold text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-50 transition-all">View Report</a>`
                            : `<button onclick="openModal('${audit.id}', '${audit.name}', '${audit.asin || audit.keyword}')" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all">Process Audit</button>`
                        }
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (err) {
                console.error('Failed to load audits', err);
            }
        }

        function openModal(id, name, subject) {
            document.getElementById('currentAuditId').value = id;
            document.getElementById('clientInfo').innerHTML = `
                <p class="text-sm"><strong>Client:</strong> ${name}</p>
                <p class="text-sm"><strong>Subject:</strong> ${subject}</p>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        document.getElementById('heliForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin material-symbols-outlined">sync</span> Generating Report...';

            const payload = {
                auditId: document.getElementById('currentAuditId').value,
                helium10Data: {
                    revenue: document.getElementById('heliRevenue').value,
                    bsr: document.getElementById('heliBsr').value,
                    reviews: document.getElementById('heliReviews').value,
                    searchVolume: document.getElementById('heliVolume').value,
                    competitionScore: document.getElementById('heliComp').value
                }
            };

            try {
                const res = await fetch(`${BACKEND_URL}/api/audit/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    alert('Report generated successfully!');
                    closeModal();
                    loadAudits();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> Generate AI Report';
            }
        });

        // Load on start
        window.addEventListener('DOMContentLoaded', loadAudits);
    </script>
</body>

</html>